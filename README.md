Based on "Building a Debugger" by Sy Brand (not a direct port)
